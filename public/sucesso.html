<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status do Pagamento</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafc; color: #222; text-align: center; padding: 40px; }
    .status-box { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; display: inline-block; padding: 32px 48px; margin-top: 40px; }
    .status-pendente { color: #f59e42; }
    .status-aprovado { color: #28a745; }
    .status-rejeitado { color: #dc3545; }
    .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 18px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>Status do Pagamento</h1>
  <div class="status-box" id="statusBox">
    <div class="spinner"></div>
    <div id="statusMsg">Consultando status da transa√ß√£o...</div>
    <div id="detalhesTransacao" style="margin-top:20px;text-align:left;max-width:400px;margin-left:auto;margin-right:auto;"></div>
  </div>
  <div id="statusPagamento" style="margin: 2em; font-size: 1.2em;"></div>
  <script src="assets/js/sucesso.js"></script>
  <script>
    async function consultarStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const transactionId = urlParams.get('transactionId');
      const produto = urlParams.get('produto');
      const curso = urlParams.get('curso');
      
      if (!transactionId) {
        document.getElementById('statusMsg').textContent = 'Transa√ß√£o n√£o encontrada.';
        return;
      }
      
      try {
        const res = await fetch(`/api/vendas/status/${transactionId}`);
        const data = await res.json();
        let status = data.status || 'pendente';
        let venda = data.venda || {};
        let msg = '';
        let cls = '';
        
        if (status === 'Aprovado' || status === 'Pago') {
          msg = 'Pagamento aprovado!';
          cls = 'status-aprovado';
        } else if (status === 'Rejeitado' || status === 'Cancelado') {
          msg = 'Pagamento rejeitado ou cancelado.';
          cls = 'status-rejeitado';
        } else {
          msg = 'Pagamento pendente. Aguarde a confirma√ß√£o.';
          cls = 'status-pendente';
        }
        
        document.getElementById('statusMsg').textContent = msg;
        document.getElementById('statusMsg').className = cls;
        document.querySelector('.spinner').style.display = status === 'Aprovado' || status === 'Rejeitado' ? 'none' : 'block';

        // Exibir detalhes da transa√ß√£o
        let detalhes = `
          <p><strong>Produto:</strong> ${venda.produto?.nome || 'Produto'}</p>
          <p><strong>N√∫mero:</strong> ${venda.cliente?.telefone || '-'}</p>
          <p><strong>Nome:</strong> ${venda.cliente?.nome || '-'}</p>
          <p><strong>M√©todo:</strong> ${venda.pagamento?.metodo || '-'}</p>
          <p><strong>Valor:</strong> MZN ${venda.pagamento?.valor || '-'}</p>
          <p><strong>Data/Hora:</strong> ${venda.dataVenda ? new Date(venda.dataVenda).toLocaleString() : '-'}</p>
        `;
        
        // Adicionar informa√ß√µes espec√≠ficas para cursos
        if (curso === 'eletrica') {
          detalhes += `
            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px;">
              <h4 style="color: #2d5a2d; margin: 0 0 10px 0;">üìö Curso de Instala√ß√µes El√©tricas</h4>
              <p style="margin: 5px 0; color: #2d5a2d;"><strong>‚úì</strong> Acesso vital√≠cio ao curso</p>
              <p style="margin: 5px 0; color: #2d5a2d;"><strong>‚úì</strong> Material did√°tico completo</p>
              <p style="margin: 5px 0; color: #2d5a2d;"><strong>‚úì</strong> Certificado de conclus√£o</p>
              <p style="margin: 5px 0; color: #2d5a2d;"><strong>‚úì</strong> Suporte t√©cnico</p>
              <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                Voc√™ receber√° um email com as instru√ß√µes de acesso em breve.
              </p>
            </div>
          `;
        }
        
        document.getElementById('detalhesTransacao').innerHTML = detalhes;
      } catch (err) {
        document.getElementById('statusMsg').textContent = 'Erro ao consultar status.';
      }
    }
    
    consultarStatus();
    setInterval(consultarStatus, 4000);
  </script>
</body>
</html> 